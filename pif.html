<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
button {
	vertical-align: center;
	text-align: center;
}
</style>
</head>
<body>
<h1>Pif da Caixa</h1>
<table>
	<tr>
		<td id="monte"><button id="btnMonte" onclick="compraPraMim(jogador, monte)"><h2>Monte: 104 cartas</h2></button></td>
		<td id="lixo"><button id="btnLixo"><h2>Lixo: Vazio</h2></button></td>
		<td id="descarte"><button id="btnDescarte" onclick="descartar(jogador, lixo)" disabled><h2>Descartar</h2></button></td>
	</tr>
	<tr>
		<td colspan="2" id="maoDoJogador"></td>
		<td id="jogar"><button id="btnBaixar" disabled><h2>Baixar jogo</h2></button></td>
	</tr>
</table>
<script>
"use strict";
var simbolos = ['&clubs;', '&diams;', '&spades;', '&hearts;'];
var monte = criarMonte();
var lixo = [];
atualizarTela(monte, lixo);
var jogador = {nome: "Jogador", cartas: [], selecao: []};
var oponente = {nome: "Computador", cartas: [], selecao: []};
var jogadores = [jogador, oponente];

for(var i = 0; i < 9; i++) {
	for(var x in jogadores) {
		jogadores[x].cartas.push(compra(monte));
	}
}

document.getElementById("btnMonte").disabled = false;
document.getElementById("btnDescarte").disabled = true;
atualizarTela(monte, lixo);
mostraMao(jogador);

function mostra(carta)
{
	var nome;
	switch (carta.valor)
	{
		case 1:
			nome = "A";
			break;
		case 11:
			nome = "J";
			break;
		case 12:
			nome = "Q";
			break;
		case 13:
			nome = "K";
			break;
		default:
			nome = "" + carta.valor;
	}
	if(carta.naipe % 2 === 0) {
		return "<span>" + nome + " " + simbolos[carta.naipe] + "</span>";
	} else {
		return "<span style=\"color:red\">" + nome + " " + simbolos[carta.naipe] + "</span>";
	}
}

function compra(baralho) {
	var i_carta = aleatorio(0, baralho.length - 1);
	var carta = baralho[i_carta];
	baralho.splice(i_carta, 1);
	//TODO: tratar situação de quando acabar o baralho
	return carta;
}

function compraPraMim(qualJogador, baralho) {
	qualJogador.cartas.push(compra(monte));
	atualizarTela(monte, lixo);
	mostraMao(qualJogador);
	document.getElementById("btnMonte").disabled = true;
	document.getElementById("btnDescarte").disabled = false;
}

function descartar(qualJogador, lixo) {
	var carta;
	for(var i in jogador.cartas) {
		//já garantimos que essa funcao apenas é usável quando
		//apenas uma carta foi selecionada
		if(jogador.cartas[i].selecao) {
			carta = (jogador.cartas[i]);
			jogador.cartas.splice(i, 1);
			lixo.push(carta);
		}
	}
	atualizarTela(monte, lixo);
	mostraMao(qualJogador);
	document.getElementById("btnDescarte").disabled = true;
}

function aleatorio(min, max)
{
	return Math.floor(Math.random() * (max - min) ) + min;
}

function criarMonte() {
	var monte = []
	for(var i = 1; i <= 13; i++)
	{
		for(var j = 0; j <= 3; j++)
		{
			monte.push({valor: i, naipe: j, selecao: false});
			//dois baralhos
			monte.push({valor: i, naipe: j, selecao: false});
		}
	}
	return monte;
}

function atualizarTela(monte, lixo) {
	document.getElementById('btnMonte').innerHTML =
	'<h2>Monte: ' + String(monte.length) + ' cartas</h2>';
	if(lixo.length > 0) {
		document.getElementById('btnLixo').innerHTML =
		'<h2>Lixo: ' + mostra(lixo[lixo.length-1]) + ' + ' + (lixo.length-1) + ' cartas</h2>';
	} else {
		document.getElementById('btnLixo').innerHTML =
		'<h2>Lixo: Vazio</h2>';
	}
}

function mostraMao(jogador) {
	var saida = "";
	for(var i in jogador.cartas)
	{
		saida += '<button id="cartaJ'+ i + '" onclick="selecionaCarta(jogador, this.id)" style="border-style: outset;" ><h2>'+mostra(jogador.cartas[i])+'</h2></button>';
	}
	document.getElementById('maoDoJogador').innerHTML = saida;
}


function selecionaCarta(jogador, nomeDaCarta) {
	document.getElementById("btnBaixar").disabled = true; 
	var idCarta = Number(nomeDaCarta.slice(-1));

	jogador.cartas[idCarta].selecao = jogador.cartas[idCarta].selecao ? false : true;
	document.getElementById(nomeDaCarta).style.borderStyle =
	document.getElementById(nomeDaCarta).style.borderStyle !== 'inset' ? 'inset' : 'outset';
	var selecionadas = [];
	for(var i in jogador.cartas) {
		if(jogador.cartas[i].selecao)
			selecionadas.push(jogador.cartas[i]);
	}
	if(selecionadas.length === 3) {
		testarJogo(selecionadas);
	}
	var botaoDescarte = document.getElementById("btnDescarte");
	if(selecionadas.length === 1) {
		botaoDescarte.disabled = false;
	} else {
		botaoDescarte.disabled = true;
	}
}

function cartasSelecionadas(jogador) {
	var selecionadas = [];
	for(var i in jogador.cartas) {
		if(jogador.cartas[i].selecao)
			selecionadas.push(jogador.cartas[i]);
	}
	return selecionadas;
}

function testarJogo(cartas) {
	cartas.sort(function(a, b) {return a.valor - b.valor});
	var c1 = cartas[0];
	var c2 = cartas[1];
	var c3 = cartas[2];
	
	var ehTeste = testarAltas(c1,c2,c3);
	var ehSeq = testarSequencia(c1, c2, c3);
	//reordenar o jogo para o As ficar no lado correto
	//tirar daqui, deve fazer isso apenas quando baixar o jogo
	if(ehSeq && c1.valor === 1 && c3.valor === 13) {
		cartas = [c2, c3, c1];
	}
	var ehTrinca = testarTrinca(c1, c2, c3);
	if(ehSeq || ehTrinca || ehTeste) {
		document.getElementById("btnBaixar").disabled = false; 
	}
}

function testarAltas(c1, c2, c3) {
	return (c1.valor > 10 && c2.valor > 10 && c3.valor > 10);
}

function testarSequencia(c1, c2, c3) {
	if (c1.naipe === c2.naipe && c1.naipe === c3.naipe) {
		return ((c2.valor === c1.valor + 1 && c3.valor === c1.valor + 2) ||
		(c1.valor === 1 && c2.valor === 12 && c3.valor === 13));
	} else {
		return false;
	}	
}

function testarTrinca(c1, c2, c3) {
	return ((c1.valor == c2.valor && c1.valor == c3.valor) &&
	(c1.naipe !== c2.naipe && c1.naipe !== c3.naipe && c2.naipe !== c3.naipe));
}
</script>
</body>
